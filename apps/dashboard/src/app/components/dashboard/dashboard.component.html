<mat-sidenav-container class="dashboard-container">
  <mat-sidenav mode="side" opened class="dashboard-sidenav">
    <div class="sidenav-header">
      <div class="sidenav-logo">TM</div>
      <div class="sidenav-title">
        <span>Workspace</span>
        <span>Task Management</span>
      </div>
    </div>
    <mat-divider></mat-divider>
    <mat-nav-list>
      <a mat-list-item class="nav-active">Dashboard</a>
      <a *ngIf="canViewAuditLogs()" mat-list-item routerLink="/audit-logs">Audit Logs</a>
      <a *ngIf="canCreateTask()" mat-list-item (click)="openTaskForm()">New Task</a>
      <a mat-list-item (click)="logout()">Logout</a>
    </mat-nav-list>
    <div class="sidenav-footer">
      Signed in as
      <span>{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span>
    </div>
  </mat-sidenav>

  <mat-sidenav-content class="dashboard-content">
    <mat-toolbar class="dashboard-toolbar">
      <div class="mx-auto flex w-full max-w-7xl items-center justify-between px-4">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-muted-foreground">Dashboard</p>
        </div>
        <div class="flex items-center gap-3"></div>
      </div>
    </mat-toolbar>

    <main class="mx-auto w-full max-w-7xl space-y-6 px-4 py-8">

      <mat-card class="filters-card">
        <mat-card-content>
          <div class="filters-row">
            <mat-form-field>
              <mat-label>Status</mat-label>
              <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onStatusChange($event.value)">
                <mat-option value="all">All Statuses</mat-option>
                <mat-option value="todo">To Do</mat-option>
                <mat-option value="in_progress">In Progress</mat-option>
                <mat-option value="done">Done</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Category</mat-label>
              <mat-select [(ngModel)]="selectedCategory" (selectionChange)="onCategoryChange($event.value)">
                <mat-option value="all">All Categories</mat-option>
                <mat-option *ngFor="let cat of getCategories()" [value]="cat">{{ cat }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Sort By</mat-label>
              <mat-select [(ngModel)]="sortBy" (selectionChange)="onSortChange($event.value)">
                <mat-option value="order">Order</mat-option>
                <mat-option value="priority">Priority</mat-option>
                <mat-option value="created">Created Date</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <section class="grid grid-cols-1 gap-y-6 gap-x-10 md:grid-cols-3" cdkDropListGroup>
        <mat-card class="board-column">
          <mat-card-header>
            <mat-card-title>To Do</mat-card-title>
            <mat-chip-set><mat-chip>{{ getTodoTasks().length }}</mat-chip></mat-chip-set>
          </mat-card-header>
          <mat-card-content>
            <div id="todo" cdkDropList [cdkDropListDisabled]="!canDragDrop()" (cdkDropListDropped)="onDrop($event)" class="space-y-3 min-h-[360px]">
              <mat-card *ngFor="let task of getTodoTasks()" cdkDrag [cdkDragDisabled]="!canDragDrop()" [cdkDragData]="task" class="task-card">
                <mat-card-content>
                  <div class="flex items-start justify-between gap-2 mb-2">
                    <h4 class="text-sm font-medium text-foreground">{{ task.title }}</h4>
                    <div class="flex items-center gap-1" *ngIf="canModifyTask()">
                      <button mat-stroked-button color="primary" (click)="openTaskForm(task)">Edit</button>
                      <button mat-stroked-button color="warn" (click)="deleteTask(task)">Delete</button>
                    </div>
                  </div>
                  <p *ngIf="task.description" class="text-sm text-muted-foreground mb-3 line-clamp-2">{{ task.description }}</p>
                  <div class="flex items-center justify-between gap-2">
                    <mat-chip [ngClass]="getPriorityColor(task.priority)">{{ task.priority }}</mat-chip>
                    <span class="text-xs text-muted-foreground">{{ task.category }}</span>
                  </div>
                </mat-card-content>
              </mat-card>

              <div *ngIf="getTodoTasks().length === 0" class="flex flex-col items-center justify-center py-12 text-center">
                <mat-chip>Empty</mat-chip>
                <p class="text-sm font-medium text-muted-foreground mt-3">No tasks yet</p>
                <p class="text-xs text-muted-foreground mt-1">Create a task to get started</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="board-column">
          <mat-card-header>
            <mat-card-title>In Progress</mat-card-title>
            <mat-chip-set><mat-chip>{{ getInProgressTasks().length }}</mat-chip></mat-chip-set>
          </mat-card-header>
          <mat-card-content>
            <div id="in_progress" cdkDropList [cdkDropListDisabled]="!canDragDrop()" (cdkDropListDropped)="onDrop($event)" class="space-y-3 min-h-[360px]">
              <mat-card *ngFor="let task of getInProgressTasks()" cdkDrag [cdkDragDisabled]="!canDragDrop()" [cdkDragData]="task" class="task-card">
                <mat-card-content>
                  <div class="flex items-start justify-between gap-2 mb-2">
                    <h4 class="text-sm font-medium text-foreground">{{ task.title }}</h4>
                    <div class="flex items-center gap-1" *ngIf="canModifyTask()">
                      <button mat-stroked-button color="primary" (click)="openTaskForm(task)">Edit</button>
                      <button mat-stroked-button color="warn" (click)="deleteTask(task)">Delete</button>
                    </div>
                  </div>
                  <p *ngIf="task.description" class="text-sm text-muted-foreground mb-3 line-clamp-2">{{ task.description }}</p>
                  <div class="flex items-center justify-between gap-2">
                    <mat-chip [ngClass]="getPriorityColor(task.priority)">{{ task.priority }}</mat-chip>
                    <span class="text-xs text-muted-foreground">{{ task.category }}</span>
                  </div>
                </mat-card-content>
              </mat-card>

              <div *ngIf="getInProgressTasks().length === 0" class="flex flex-col items-center justify-center py-12 text-center">
                <mat-chip>Empty</mat-chip>
                <p class="text-sm font-medium text-muted-foreground mt-3">No tasks yet</p>
                <p class="text-xs text-muted-foreground mt-1">Move tasks here when active</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="board-column">
          <mat-card-header>
            <mat-card-title>Done</mat-card-title>
            <mat-chip-set><mat-chip>{{ getDoneTasks().length }}</mat-chip></mat-chip-set>
          </mat-card-header>
          <mat-card-content>
            <div id="done" cdkDropList [cdkDropListDisabled]="!canDragDrop()" (cdkDropListDropped)="onDrop($event)" class="space-y-3 min-h-[360px]">
              <mat-card *ngFor="let task of getDoneTasks()" cdkDrag [cdkDragDisabled]="!canDragDrop()" [cdkDragData]="task" class="task-card">
                <mat-card-content>
                  <div class="flex items-start justify-between gap-2 mb-2">
                    <h4 class="text-sm font-medium text-foreground">{{ task.title }}</h4>
                    <div class="flex items-center gap-1" *ngIf="canModifyTask()">
                      <button mat-stroked-button color="primary" (click)="openTaskForm(task)">Edit</button>
                      <button mat-stroked-button color="warn" (click)="deleteTask(task)">Delete</button>
                    </div>
                  </div>
                  <p *ngIf="task.description" class="text-sm text-muted-foreground mb-3 line-clamp-2">{{ task.description }}</p>
                  <div class="flex items-center justify-between gap-2">
                    <mat-chip [ngClass]="getPriorityColor(task.priority)">{{ task.priority }}</mat-chip>
                    <span class="text-xs text-muted-foreground">{{ task.category }}</span>
                  </div>
                </mat-card-content>
              </mat-card>

              <div *ngIf="getDoneTasks().length === 0" class="flex flex-col items-center justify-center py-12 text-center">
                <mat-chip>Empty</mat-chip>
                <p class="text-sm font-medium text-muted-foreground mt-3">No tasks yet</p>
                <p class="text-xs text-muted-foreground mt-1">Archive completed work here</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </section>
    </main>
  </mat-sidenav-content>
</mat-sidenav-container>

<app-task-form *ngIf="showTaskForm" [task]="editingTask" (close)="closeTaskForm()" (saved)="onTaskSaved()"></app-task-form>
